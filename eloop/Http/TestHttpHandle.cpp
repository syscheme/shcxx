#include "TestHttpHandle.h"
#include <fstream>

namespace ZQ {
namespace eloop {
	/*
// ---------------------------------------
// class TestHttpHandleFactory
// ---------------------------------------
TestHttpHandleFactory::TestHttpHandleFactory()
{

}
TestHttpHandleFactory::~TestHttpHandleFactory()
{

}

HttpHandler::Ptr TestHttpHandleFactory::create( HttpConnection& processor )
{
	HttpHandler::Ptr handler = new TestHttpHandle(processor);
	return handler;
}*/


// --------------------------------------------------
// class TestHttpHandle
// --------------------------------------------------
TestHttpHandle::TestHttpHandle(HttpConnection& conn,ZQ::common::Log& logger,const Properties& dirProps, const Properties& appProps)
		:HttpHandler(conn,logger,dirProps, appProps)
{

}

TestHttpHandle::~TestHttpHandle()
{

}

void TestHttpHandle::Response()
{

}

void TestHttpHandle::ResponseIndex()
{

}

bool TestHttpHandle::onHeadersEnd( const HttpMessage::Ptr msg)
{
	HttpMessage::Ptr outmsg = new HttpMessage(HttpMessage::MSG_RESPONSE);

	printf("url = %s\n",msg->url().c_str());
	int code = 200;
	outmsg->code(code);
	outmsg->status(HttpMessage::code2status(code));
	outmsg->keepAlive(true);
	outmsg->header("Server","LibAsYnc HtTp SeRVer");
	outmsg->header("Date",HttpMessage::httpdate());

	std::string body = "Welcome to tinyweb. <a href=\"index.html\">index.html</a>";

	outmsg->contentLength(body.length());

	std::string head = outmsg->toRaw();
	_conn.write(head.c_str(),head.length());

	_conn.write(body.c_str(),body.length());

	//_conn.setkeepAlive(false);

	return true;
}


bool TestHttpHandle::onBodyData( const char* data, size_t size)
{
	return true;
}


void TestHttpHandle::onMessageCompleted()
{

}


void TestHttpHandle::onParseError( int error,const char* errorDescription )
{

}

void TestHttpHandle::onHttpDataSent()
{

}

void TestHttpHandle::onHttpDataReceived( size_t size )
{

}

// --------------------------------------------------
// class TestHttpHandle
// --------------------------------------------------
DownloadeHandle::DownloadeHandle(HttpConnection& conn,ZQ::common::Log& logger,const Properties& dirProps, const Properties& appProps)
		:HttpHandler(conn,logger,dirProps,appProps),
		_buf(NULL),
		_fp(NULL),
		_dataSize(1024*1024)
{
	_buf = (char*)malloc(_dataSize);
}

DownloadeHandle::~DownloadeHandle()
{
	free(_buf);
}

void DownloadeHandle::Response()
{

}

void DownloadeHandle::ResponseIndex()
{

}


bool DownloadeHandle::onHeadersEnd( const HttpMessage::Ptr msg)
{
	HttpMessage::Ptr outmsg = new HttpMessage(HttpMessage::MSG_RESPONSE);

	//printf("url = %s\n",msg->url().c_str());
	int code = 200;
	outmsg->code(code);
	outmsg->status(HttpMessage::code2status(code));
	outmsg->keepAlive(true);
	outmsg->header("Server","LibAsYnc HtTp SeRVer");
	outmsg->header("Date",HttpMessage::httpdate());

	std::string url= msg->url();
	std::string filename = url.substr(url.find_last_of('/')+1);

	filename = "D:\\vedio\\" + filename;

	std::ifstream in(filename.c_str());   
	in.seekg(0,std::ios::end);   
	long size = in.tellg();   
	in.close();
	printf("content length = %ld\n",size);

	outmsg->contentLength(size);

	std::string head = outmsg->toRaw();
	_conn.write(head.c_str(),head.length());


	_fp = fopen(filename.c_str(),"rb");

	if (_fp == NULL)
	{
		return false;
	}

	return true;
}


bool DownloadeHandle::onBodyData( const char* data, size_t size)
{
	return true;
}


void DownloadeHandle::onMessageCompleted()
{

}


void DownloadeHandle::onParseError( int error,const char* errorDescription )
{

}

void DownloadeHandle::onHttpDataSent()
{
	memset(_buf,0,_dataSize);
	int ret = fread(_buf,1,_dataSize,_fp);
	if (ret > 0)
	{
		//printf("send data size = %d\n",ret);
		_conn.write(_buf,ret);
	}else
	{
		close();
	}
}

void DownloadeHandle::onHttpDataReceived( size_t size )
{

}

void DownloadeHandle::close()
{
	fclose(_fp);
}

// --------------------------------------------------
// class UtilHandle
// --------------------------------------------------
UtilHandle::UtilHandle(HttpConnection& conn,ZQ::common::Log& logger,const Properties& dirProps, const Properties& appProps)
		:HttpHandler(conn,logger,dirProps, appProps)
{

}

UtilHandle::~UtilHandle()
{

}

void UtilHandle::Response()
{

}

void UtilHandle::ResponseIndex()
{

}

bool UtilHandle::onHeadersEnd( const HttpMessage::Ptr msg)
{
	HttpMessage::Ptr outmsg = new HttpMessage(HttpMessage::MSG_RESPONSE);

	printf("url = %s\n",msg->url().c_str());
	int code = 200;
	outmsg->code(code);
	outmsg->status(HttpMessage::code2status(code));
	outmsg->keepAlive(true);
	outmsg->header("Server","LibAsYnc HtTp SeRVer");
	outmsg->header("Date",HttpMessage::httpdate());

	std::string body = "cpu=[1,2,3,4,5,6,7,8,9]";

	outmsg->contentLength(body.length());

	std::string head = outmsg->toRaw();
	_conn.write(head.c_str(),head.length());

	_conn.write(body.c_str(),body.length());

	//_conn.setkeepAlive(false);

	return true;
}

bool UtilHandle::onBodyData( const char* data, size_t size)
{
	return true;
}

void UtilHandle::onMessageCompleted()
{

}

void UtilHandle::onParseError( int error,const char* errorDescription )
{

}

void UtilHandle::onHttpDataSent()
{

}

void UtilHandle::onHttpDataReceived( size_t size )
{

}


// --------------------------------------------------
// class EmptyHttpHandle
// --------------------------------------------------
EmptyHttpHandle::EmptyHttpHandle(HttpConnection& conn,ZQ::common::Log& logger,const Properties& dirProps, const Properties& appProps)
	:HttpHandler(conn,logger,dirProps, appProps)
{

}

EmptyHttpHandle::~EmptyHttpHandle()
{

}

void EmptyHttpHandle::Response()
{

}

void EmptyHttpHandle::ResponseIndex()
{

}

bool EmptyHttpHandle::onHeadersEnd( const HttpMessage::Ptr msg)
{
	HttpMessage::Ptr outmsg = new HttpMessage(HttpMessage::MSG_RESPONSE);

	//printf("url = %s\n",msg->url().c_str());
	int code = 200;
	outmsg->code(code);
	outmsg->status(HttpMessage::code2status(code));
	outmsg->keepAlive(true);
	outmsg->header("Server","Http Download Server");
	outmsg->header("Date",HttpMessage::httpdate());

	//std::string body = "Welcome to tinyweb. <a href=\"index.html\">index.html</a>";

	//printf("body size = %d\n",body.size());

	//outmsg->contentLength(100*body.length());

	std::string head = outmsg->toRaw();
	_conn.write(head.c_str(),head.length());

	return true;
}

bool EmptyHttpHandle::onBodyData( const char* data, size_t size)
{
	return true;
}

void EmptyHttpHandle::onMessageCompleted()
{

}

void EmptyHttpHandle::onParseError( int error,const char* errorDescription )
{

}

void EmptyHttpHandle::onHttpDataSent()
{
	//std::string body = "Welcome to tinyweb. <a href=\"index.html\">index.html</a>";

	std::string body = "12345678910*12345678910*12345678910*12345678910*12345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345689 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101236666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101266666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234563456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567866666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234569101234567\
		666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345678910123456789101234666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345656\
		6666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456789101234567866666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234569101234567891078910\
		12345678910*12345678910*12345678910*12345678910*12345678910123456789101234567891012345678910123456789101234567891012345678910123456666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345667891012345678910123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101266666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234563456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345634567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234566\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345610123456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456789101234567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101236666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345656\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456766666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234568910123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345623456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234560123456789101234567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345610123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101236666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012346666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678916666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456012345678910123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345656\
		78910123456789101234567891012345678910123666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345645678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789166666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234560123456789101234567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345610123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101236666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456456\
		78910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012346666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456\12345678910*12345678910*12345678910*12345678910*1234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789 \
		1012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678916666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666891012345678910123456012345678910123456\
		7891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345656\
		78910123456789101234567891012345678910123666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666689101234567891012345645678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567891012345678910123456789101234567\
		66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666668910123456789101234567891012345678910123456";

	printf("body size = %d\n",body.length());
	_conn.write(body.c_str(),body.length());

}

void EmptyHttpHandle::onHttpDataReceived( size_t size )
{

}

} }//namespace ZQ::eloop
